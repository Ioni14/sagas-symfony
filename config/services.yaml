imports:
    - { resource: contexts/* }

services:
    _defaults:
        autowire: true
        autoconfigure: true
#        bind:
#            Symfony\Component\Messenger\Transport\Sender\SenderInterface $reliableSender: '@messenger.transport.outbox'

    Shared\Infrastructure\:
        resource: '../src/_Shared/Infrastructure'

#    Shared\Infrastructure\Messenger\OutboxProcessor:
#        autoconfigure: false
#        tags:
#            - { name: messenger.message_handler, handles: '*' }

    Shared\Application\SagaManager:
        tags:
            - { name: 'messenger.message_handler', handles: '*' }

#    app.messenger.handle_saga:
#    messenger.middleware.handle_message:
#        abstract: true
#        class: Shared\Infrastructure\Messenger\HandleSagaMiddleware
#        arguments:
#            - !abstract defined in MessengerPass

    saga_transaction:
        class: Shared\Infrastructure\Messenger\SagaTransactionMiddleware
    Shared\Infrastructure\Messenger\SagaTransactionMiddleware: '@saga_transaction'
    saga_persistence:
        class: Shared\Infrastructure\Messenger\SagaPersistenceMiddleware
        arguments:
            $sagaHandlerPrototypes: !tagged_iterator saga_handler
    Shared\Infrastructure\Messenger\SagaPersistenceMiddleware: '@saga_persistence'

    Shared\Application\SagaPersisterInterface: '@Shared\Infrastructure\DoctrineSagaPersister'
